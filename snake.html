<html>
<head>
<style>
canvas {
    background-color: #f1f1f1;
    display: block;
    margin: 0 auto;
}
</style>

</head> 
<body>
    <canvas id="myCanvas" width="760" height="580"></canvas>
</body>
<script>
var requestAnimationId = null;
var gamePaused = true;
var vertPadding = 50;
var vertOffSet = 3;
var horiOffSet = 3;
var boardWidth = 58;
var boardHeight = 40;
var block = {
    width: 10,
    height: 10,
    color: "#DDDDDD",
    snakeColor: "black",
    mouseColor: "red"
}
var score = 0;
var snake = [[0,0]];
var snakeDirections = [[0,1], [0,-1], [-1, 0], [1,0],[0,0]]; // left, right, up, down
var currSnakeDirection = 4;
var lastKeyCode = null;

var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");

function refreshSnakeDirection() {
    if (lastKeyCode === 37) currSnakeDirection = 1;
    else if (lastKeyCode === 39) currSnakeDirection = 0;
    else if (lastKeyCode === 38) currSnakeDirection = 2;
    else if (lastKeyCode === 40) currSnakeDirection = 3;
}

/**

keyDownHandler(e);
we only recognize direction keys, since the snake cannot travel backwards, we do not allow opposite
direction key be pressed consecutively, we also make sure the snake's current direction isn't the
opposite of what was clicked, snake direction is updated at every frame, so we can avoid race conditions
where lastKeyCode does not match with snake direction and snake tries to travel in opposite direction

**/
function keyDownHandler(e) {
    if (e.keyCode === 32) { // space
        currSnakeDirection = 4
        gamePaused = true;
    } else {
        gamePaused = false;
        if (e.keyCode === 37 && lastKeyCode !== 39 && currSnakeDirection !== 0) lastKeyCode = 37; // left
        else if (e.keyCode === 39 && lastKeyCode !== 37 && currSnakeDirection !== 1) lastKeyCode = 39; // right
        else if (e.keyCode === 38 && lastKeyCode !== 40 && currSnakeDirection !== 3) lastKeyCode = 38;// up
        else if (e.keyCode === 40 && lastKeyCode !== 38 && currSnakeDirection !== 2) lastKeyCode = 40; // down
    }
}

function gameover() {
    console.log('game over')
    ctx.clearRect(200,230,370,100);
    ctx.font = "50px Arial";
    ctx.fillStyle = "#FF0000";
    ctx.fillText("GAME OVER", 230, 300);

    cancelAnimationFrame(requestAnimationId);
}

function moveSnake(x, y) {
    function transformPositionIfOutOfBound(pos) {
        var x = pos[0];
        var y = pos[1];
        if (x < 0)              pos[0] = boardHeight-1;
        if (x >= boardHeight)    pos[0] = 0;
        if (y < 0)              pos[1] = boardWidth-1;
        if (y >= boardWidth)     pos[1] = 0;
    }

    function validPosition(x, y) {
        var head = snake[snake.length-1];
        if (blocks[x][y].isSnake) {
            if (x === head[0] && y === head[1]) return true;
            return false;
        }
        return true;
    }

    var head = snake[snake.length-1];
    var headx = head[0];
    var heady = head[1];
    var newHead = [headx + x, heady + y];

    transformPositionIfOutOfBound(newHead);

    if (!gamePaused && !validPosition(newHead[0], newHead[1])) {
        gameover();
    }

    snake.push(newHead);
    var ateMouse = blocks[newHead[0]][newHead[1]].isMouse;
    blocks[newHead[0]][newHead[1]].isSnake = true;
    blocks[newHead[0]][newHead[1]].isMouse = false;

    if (!ateMouse) {
        var tail = snake.shift();
        var tailx = tail[0];
        var taily = tail[1];
        blocks[tailx][taily].isSnake = false;
    } else {
        generateNewMouse();
        score++;
    }
}

function generateNewMouse() {
    var x = Math.floor(Math.random()*blocks.length);
    var y = Math.floor(Math.random()*blocks[0].length);
    while(blocks[x][y].isSnake) {
        x = Math.floor(Math.random()*blocks.length);
        y = Math.floor(Math.random()*blocks[0].length);
    }
    blocks[x][y].isMouse = true;
}

function drawBlock(x,y,width,height,color) {
    ctx.beginPath();
    ctx.rect(x, y, width, height);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.closePath();
}
var blocks = (function() {
    var blocks = [];
    for (var r = 0; r < boardHeight; r++) {
        blocks.push([]);
        for (var c = 0; c < boardWidth; c++) {
            blocks[r][c] = {
                isSnake: false,
                isMouse: false,
            }
        }
    }
    return blocks;
}());

function placeSnakeAndMouses() {
    blocks[snake[0][0]][snake[0][1]].isSnake = true;
    generateNewMouse();
}

function drawBlocks() {
    for (var r = 0; r < blocks.length; r++) {
        for (var c = 0; c < blocks[r].length; c++) {
            var x = c*(block.width + horiOffSet) + horiOffSet;
            var y = r*(block.height + vertOffSet) + vertOffSet + vertPadding;

            var color = block.color;
            if (blocks[r][c].isSnake)
                color = block.snakeColor;
            else if (blocks[r][c].isMouse)
                color = block.mouseColor

            drawBlock(x, y, block.width, block.height, color);
        }
    }
}

function drawScore() {
    ctx.clearRect(1,1,110,50);
    ctx.font = "20px Arial";
    ctx.fillStyle = "#0095DD";
    ctx.fillText("Score: " + score, 8, 20);
}

function drawInstructions() {
    ctx.clearRect(1,1,200,50);
    ctx.font = "20px Arial";
    ctx.fillStyle = "#000000";
    ctx.fillText("Press space key to pause, and any direction key to continue", 120, 20);
}

function draw() {
    setTimeout(function() {
        requestAnimationId = requestAnimationFrame(draw);
        
        // animating/drawing code goes here
        refreshSnakeDirection();
        drawBlocks();
        if (!gamePaused) moveSnake(snakeDirections[currSnakeDirection][0], snakeDirections[currSnakeDirection][1]);
        drawScore();
    }, 1000 / 20);
    
}

function init() {
    document.addEventListener("keydown", keyDownHandler, false);
    placeSnakeAndMouses();
    drawInstructions();
    
    draw();
}

init();

</script>

<html>